#region Header
/* ============================================ 
 *			    Strix Unity Library
 *		https://github.com/strix13/UnityLibrary
 *	============================================ 	
 *	작성자 : Strix
 *	
 *	기능 : 
 *	오리지널 소스코드의 경우 에디터 - Inspector에서 봐야만 갱신이 되었는데,
 *	현재는 SCManagerGetComponent.DoUpdateGetComponentAttribute 를 호출하면 갱신하도록 변경하였습니다.
 *	Awake에서 호출하시면 됩니다.
 *	
 *	Private 변수는 갱신되지 않습니다.
 *	
 *	오리지널 소스 링크
 *	https://openlevel.postype.com/post/683269
   ============================================ */
#endregion Header

using UnityEngine;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;

[AttributeUsage(AttributeTargets.Field, Inherited = true, AllowMultiple = false)]
public abstract class GetComponentAttributeBase : UnityEngine.PropertyAttribute
{
    public bool bIsPrint_OnNotFound;

    public abstract object GetComponent(MonoBehaviour pTargetMono, Type pElementType);
}

[AttributeUsage(AttributeTargets.Field, Inherited = true, AllowMultiple = false)]
public class GetComponentAttribute : GetComponentAttributeBase
{
    public override object GetComponent(MonoBehaviour pTargetMono, Type pElementType)
    {
        MethodInfo getter = typeof(MonoBehaviour)
                 .GetMethod("GetComponents", new Type[0])
                 .MakeGenericMethod(pElementType);
        return getter.Invoke(pTargetMono, null);
    }
}

[AttributeUsage(AttributeTargets.Field, Inherited = true, AllowMultiple = false)]
public class GetComponentInChildrenAttribute : GetComponentAttributeBase
{
    public bool bSearch_By_ComponentName = false;
    public string strComponentName;

    public GetComponentInChildrenAttribute(System.Object pObject, bool bIsPrint_OnNotFound = true)
    {
        bSearch_By_ComponentName = true;
        this.strComponentName = pObject.ToString();
        this.bSearch_By_ComponentName = true;
        this.bIsPrint_OnNotFound = bIsPrint_OnNotFound;
    }

    public GetComponentInChildrenAttribute(bool bIsPrint_OnNotFound = true)
    {
        bSearch_By_ComponentName = false;
        this.bIsPrint_OnNotFound = bIsPrint_OnNotFound;
    }

    public override object GetComponent(MonoBehaviour pTargetMono, Type pElementType)
    {
        MethodInfo getter = typeof(MonoBehaviour)
            .GetMethod("GetComponentsInChildren", new Type[] { typeof(bool) })
            .MakeGenericMethod(pElementType);
        return getter.Invoke(pTargetMono,
                new object[] { true });
    }
}

[AttributeUsage(AttributeTargets.Field, Inherited = true, AllowMultiple = false)]
public class GetComponentInParentAttribute : GetComponentAttributeBase
{
    public override object GetComponent(MonoBehaviour pTargetMono, Type pElementType)
    {
        MethodInfo getter = typeof(MonoBehaviour)
          .GetMethod("GetComponentsInParent", new Type[] { typeof(bool) })
          .MakeGenericMethod(pElementType);
        return getter.Invoke(pTargetMono,
                new object[] { });
    }
}


static public class SCManagerGetComponent
{
    static public Component GetComponentInChildren(this Component pTarget, string strObjectName, System.Type pComponentType)
    {
        Component[] arrComponentFind = pTarget.transform.GetComponentsInChildren(pComponentType);
        for (int i = 0; i < arrComponentFind.Length; i++)
        {
            if (arrComponentFind[i].name.Equals(strObjectName))
                return arrComponentFind[i];
        }
        return null;
    }

    static public void DoUpdateGetComponentAttribute(MonoBehaviour pTarget)
    {
        System.Type pType = pTarget.GetType();
        FieldInfo[] arrFields = pType.GetFields(BindingFlags.Public | BindingFlags.Instance);
        ProcUpdateComponentAttribute(pTarget, arrFields);

        arrFields = pType.GetFields(BindingFlags.NonPublic | BindingFlags.Instance);
        ProcUpdateComponentAttribute(pTarget, arrFields);

        arrFields = pType.GetFields(BindingFlags.Public | BindingFlags.Static);
        ProcUpdateComponentAttribute(pTarget, arrFields);

        arrFields = pType.GetFields(BindingFlags.NonPublic | BindingFlags.Static);
        ProcUpdateComponentAttribute(pTarget, arrFields);
    }

    static private void ProcUpdateComponentAttribute(MonoBehaviour pTargetMono, FieldInfo[] arrFields)
    {
        for (int i = 0; i < arrFields.Length; i++)
        {
            FieldInfo pField = arrFields[i];
            object[] arrCustomAttributes = pField.GetCustomAttributes(true);

            for (int j = 0; j < arrCustomAttributes.Length; j++)
            {
                GetComponentAttributeBase pGetcomponentAttribute = arrCustomAttributes[j] as GetComponentAttributeBase;
                if (pGetcomponentAttribute == null) continue;

                System.Type pTypeField = pField.FieldType;
                object pComponent = null;

                if (pTypeField.IsArray)
                {
                    pComponent = pGetcomponentAttribute.GetComponent(pTargetMono, pTypeField.GetElementType());
                }
                else if (pTypeField.IsGenericType)
                {
                    pComponent = ProcUpdateComponent_Generic(pTargetMono, pField, (GetComponentInChildrenAttribute)pGetcomponentAttribute, pTypeField);
                }
                else
                {
                    if (pGetcomponentAttribute is GetComponentAttribute)
                        pComponent = pTargetMono.GetComponent(pTypeField);
                    else if (pGetcomponentAttribute is GetComponentInChildrenAttribute)
                    {
                        GetComponentInChildrenAttribute pAttributeInChildren = (GetComponentInChildrenAttribute)pGetcomponentAttribute;
                        if (pAttributeInChildren.bSearch_By_ComponentName)
                            pComponent = pTargetMono.GetComponentInChildren(pAttributeInChildren.strComponentName, pTypeField);
                        else
                            pComponent = pTargetMono.GetComponentInChildren(pTypeField, true);
                    }
                    else if (pGetcomponentAttribute is GetComponentInParentAttribute)
                        pComponent = pTargetMono.GetComponentInParent(pTypeField);
                }

                if (pComponent == null && pGetcomponentAttribute.bIsPrint_OnNotFound)
                {
                    GetComponentInChildrenAttribute pAttribute = (GetComponentInChildrenAttribute)pGetcomponentAttribute;
                    if (pAttribute != null && pAttribute.bSearch_By_ComponentName)
                        Debug.LogWarning(pTargetMono.name + string.Format(".{0}<{1}>({2}) Result == null", pGetcomponentAttribute.GetType().Name, pTypeField, pAttribute.strComponentName), pTargetMono);
                    else
                        Debug.LogWarning(pTargetMono.name + string.Format(".{0}<{1}> Result == null", pGetcomponentAttribute.GetType().Name, pTypeField), pTargetMono);
                    continue;
                }

                if (pTypeField.IsGenericType == false)
                    pField.SetValue(pTargetMono, pComponent);
            }
        }
    }

    static private object ProcUpdateComponent_Generic(MonoBehaviour pTargetMono, FieldInfo pField, GetComponentInChildrenAttribute pGetComponentAttribute, System.Type pTypeField)
    {
        object pComponent = null;
        System.Type pTypeField_Generic = pTypeField.GetGenericTypeDefinition();
        Type[] arrArgumentsType = pTypeField.GetGenericArguments();

        if (pTypeField_Generic == typeof(List<>))
        {
            // List의 경우 GetComponentsInChildren 을 통해 Array를 얻은 뒤
            pComponent = pGetComponentAttribute.GetComponent(pTargetMono, arrArgumentsType[0]);
            // List 생성자에 Array를 집어넣는다.
            pField.SetValue(pTargetMono, System.Activator.CreateInstance(pTypeField, pComponent));
        }
        else if (pTypeField_Generic == typeof(Dictionary<,>))
        {
            pComponent = ProcUpdateComponent_Dictionary(pTargetMono, pField, pTypeField, pGetComponentAttribute, arrArgumentsType[0], arrArgumentsType[1]);
        }

        return pComponent;
    }

    static private object ProcUpdateComponent_Dictionary(MonoBehaviour pTargetMono, FieldInfo pField, System.Type pTypeField, GetComponentInChildrenAttribute pAttributeInChildren, Type pType_DictionaryKey, Type pType_DictionaryValue)
    {
        object pComponent = pAttributeInChildren.GetComponent(pTargetMono, pType_DictionaryValue);
        Array arrComponent = pComponent as Array;

        if (arrComponent.Length == 0)
        {
            return null;
        }

        var Method_Add = pTypeField.GetMethod("Add", new[] {
                                pType_DictionaryKey, pType_DictionaryValue });

        // Reflection의 메소드는 Instance에서만 호출할수 있다.
        var pInstanceDictionary = System.Activator.CreateInstance(pTypeField);

        if (pType_DictionaryKey == typeof(string))
        {
            for (int k = 0; k < arrComponent.Length; k++)
            {
                Component pComponentChild = arrComponent.GetValue(k) as Component;
                Method_Add.Invoke(pInstanceDictionary, new object[] {
                                    pComponentChild.name,
                                    pComponentChild });
            }
        }
        else if (pType_DictionaryKey.IsEnum)
        {
            bool bIsDerived_DictionaryItem = false;
            Type[] arrInterfaces = pType_DictionaryValue.GetInterfaces();
            string strTypeName = typeof(IDictionaryItem<>).Name;
            for (int i = 0; i < arrInterfaces.Length; i++)
            {
                if (arrInterfaces[i].Name.Equals(strTypeName))
                {
                    bIsDerived_DictionaryItem = true;
                    break;
                }
            }
            if (bIsDerived_DictionaryItem)
            {
                var method = pType_DictionaryValue.GetMethod("IDictionaryItem_GetKey");
                for (int k = 0; k < arrComponent.Length; k++)
                {
                    Component pComponentChild = arrComponent.GetValue(k) as Component;
                    Method_Add.Invoke(pInstanceDictionary, new object[] {
                                    method.Invoke(pComponentChild, null),
                                    pComponentChild });
                }
            }
            else
            {
                for (int k = 0; k < arrComponent.Length; k++)
                {
                    Component pComponentChild = arrComponent.GetValue(k) as Component;
                    try
                    {
                        var pEnum = System.Enum.Parse(pType_DictionaryKey, pComponentChild.name, true);
                        Method_Add.Invoke(pInstanceDictionary, new object[] {
                                    pEnum,
                                    pComponentChild });
                    }
                    catch { }
                }
            }
        }
        else
        {
            Debug.LogError("GetComponentAttribute Error Dictionary Key 타입은 string, enum입니다. Key Type : " + pType_DictionaryKey.Name);
            return null;
        }

        pField.SetValue(pTargetMono, pInstanceDictionary);
        return pComponent;
    }


}